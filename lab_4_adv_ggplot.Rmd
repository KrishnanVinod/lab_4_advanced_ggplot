---
title: "Lab 4 : Advanced ggplot"
author: "Jeremy Morris"
output: 
  html_document: 
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(here)
library(nlme)
library(nycflights13)
library(hrbrthemes)
library(ggrepel)
```


# Components of a basic plot

# create initial plot
```{r basic}
ggplot(data = mpg, aes(x=displ, y=hwy, colour = factor(cyl))) +
  geom_point()
```

What is happening with above call to ggplot? The first part of the call maps aesthetics to data. The call to `summary` helps us look at the plot object.

```{r basic_summary}
p <- ggplot(data = mpg, aes(x=displ, y=hwy, colour = factor(cyl)))
summary(p) 
```

The resulting mapping is as follows (showing the top 10 rows only)
```{r mapping}
head(data.frame(x=mpg$displ, y=mpg$hwy, colour=factor(mpg$cyl)), n = 10)
```

Note that it can't be plotted yet because there are no layers at this point
```{r basic_plot}
p 
```

To add a layer we add a geometric object (a.k.a geom); in this case it's a point geom

```{r add_geom}
p <- p + geom_point()
summary(p) # examine the components of the plot
```

Now that there is a layer, it can be plotted. Note that we can save a plot to a variable and then plot it by calling just that variable. We can also assign a base visualization to a variable and then add to it later. We'll see that a little as we go on.
```{r plot}
p # plot it
```

Applying other geoms; the geom type determines the type of the plot
line: grammatically correct, but doesn't make sense

```{r line_wrong}
ggplot(data = mpg, aes(x=displ, y=hwy, colour = factor(cyl))) +
  geom_line()
```

bar: grammatically correct, but doesn't make sense

```{r bar_wrong}
ggplot(data = mpg, aes(x=displ, y=hwy, colour = factor(cyl))) +
  geom_bar(stat="identity") 
```

Refer to lab 2 for a list of all `geoms`

Lets go back to the original scatter plot and add some regressions
```{r add_regression1}
p <- ggplot(data = mpg, aes(x=displ, y=hwy, colour = factor(cyl))) +
  geom_point()
```

Now create an additional layer with a regression. Note how we're adding `geom_smooth` to the existing plot.
```{r add_regression2}
p + geom_smooth()
```

What happens if we add the mappings at the geom level?
```{r add_to_geom}
ggplot(data = mpg) +
  geom_point(aes(x=displ, y=hwy, colour = factor(cyl))) +
  geom_smooth(aes(x=displ,y=hwy))
```

## Facet

Facets allow you to break one chart into multiples. This can be helpful if you have too many dimensions and want to represent something more complex. Each of the facets will have the same format, just split on a specific value from the data.

The following creates a facet by year.

```{r facet1}
ggplot(data = mpg, aes(x=displ, y=hwy,color=factor(cyl))) + 
  geom_point() +
  facet_grid(. ~ year)
```

The `facet_grind` function allows you to specify a split for rows and columns. The following plot splits by `cyl` and `year` in the rows and columns respectively. Facets also allow you to control how standardized the plots are. By default, all axes will share the same dimensions. The following shows how to allow the y-axis to have its own limits.
```{r free_y}
ggplot(data = mpg, aes(x=displ, y=hwy)) + 
    geom_point() +
    facet_grid(cyl ~ year,scales='free_y')
```

We can also specify that the grid be vertical instead of horizontal.
```{r horizontal_grid}
ggplot(data = mpg, aes(x=displ, y=hwy)) + 
  geom_point() +
  facet_grid(year ~ .) 
```


## Coordinates

## Some examples

### Airport Delays Over Time

Data Prep  
1. Add a binary flag (1/0) for delay
2. Compute summaries by origin and month -- n = total flights, delay = total delayed flights

```{r data_prep}
delay_by_month <- flights %>% mutate(delay=if_else(dep_delay > 0,1,0)) %>% 
  group_by(origin,month) %>% summarise(n=n(),delay=sum(delay,na.rm=T))
```

The standard plot may look something like this.

```{r standard1}
ggplot(delay_by_month) +
  geom_bar(aes(x=month,y=delay,fill=origin),position='dodge',stat='identity') +
  scale_x_continuous(breaks=c(1:12)) +
  labs(x='Month',y='# of Flights with a Delay',fill='Origin',title='LGA Often Has the Fewest Delays') +
  theme_ipsum()
```

If we want to only highlight only the important stuff...
```{r highlight_important}
ggplot(delay_by_month) +
  geom_bar(aes(x=month,y=delay,fill=origin),position='dodge',stat='identity',color='#8ca2a6') +
  scale_x_continuous(breaks=c(1:12)) +
  scale_fill_manual(values=alpha(c('#bcc3c4','#bcc3c4','#fbbf5e'),0.7)) +
  labs(x='Month',y='# of Flights with a Delay',fill='Origin',title='LGA Often Has the Fewest Delays') +
  theme_ipsum()
```

Push necessary, but non-message-impacting to the background...
```{r push_back}
ggplot(delay_by_month) + 
  geom_line(aes(x=month,y=delay,color=origin),size=1) +
  scale_color_manual(values=alpha(c('#bcc3c4','#bcc3c4','#fbbf5e'),0.7)) +
  scale_x_continuous(breaks=c(1:12),labels=c('Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec')) +
  labs(x='Month',y='# of Flights with a Delay',color='Origin',title='LGA Often Has the Fewest Delays') +
  theme_ipsum() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```

### Delay Comparison

Data Prep  
1. Add variable for delay (1 = delay, 0 = not)
2. Compute summaries of total flights and delays
3. Add pct delayed and mean(n), mean(p)

```{r final_data_prep}
delay_by_carrier <- flights %>% mutate(delay=if_else(dep_delay > 0,1,0)) %>% 
  group_by(carrier) %>% summarise(n=n(),delay=sum(delay,na.rm=T)) %>% ungroup() %>%
  mutate(p=delay/n,mean_n=mean(n),mean_p=mean(p))

quadrant_labels <- tibble(label=c('High Flights, Low Delay Pct','High Flights, High Delay Pct'),x=c(45000,45000),y=c(0.21,0.54),color=c('#292929','#fa6d29'))
```


Final scatterplot creating a visual hierarchy.

```{r final,fig.width=10,fig.height=8}
ggplot(delay_by_carrier) + 
  
  geom_point(data=filter(delay_by_carrier,n < mean_n),aes(x=n,y=p),color='#bcc3c4',size=3) +
  geom_text_repel(data=filter(delay_by_carrier,n < mean_n),aes(x=n,y=p,label = carrier),color='#bcc3c4',size=5) +
  
  geom_point(data=filter(delay_by_carrier,n >= mean_n,p < mean_p),aes(x=n,y=p),color='#fa6d29',size=3) +
  geom_text_repel(data=filter(delay_by_carrier,n >= mean_n,p < mean_p),aes(x=n,y=p,label = carrier),color='#fa6d29',size=5) +

  geom_point(data=filter(delay_by_carrier,n >= mean_n,p >= mean_p),aes(x=n,y=p),color='#292929',size=3) +
  geom_text_repel(data=filter(delay_by_carrier,n >= mean_n,p >= mean_p),aes(x=n,y=p,label = carrier),color='#292929',size=5) +
  
  geom_hline(yintercept=mean(delay_by_carrier$p)) +
  geom_vline(xintercept=mean(delay_by_carrier$n)) +
  
  scale_x_continuous(labels=scales::comma) +
  scale_y_continuous(labels=scales::percent) +
  labs(x='Total Flights',y='Percent Delayed',title='Percentage Delay vs Total Flights') +
  
  geom_text(data=quadrant_labels,aes(x=x,y=y,label=label,color=label),size=6) +
  scale_color_manual(values=quadrant_labels$color) +
  
  theme_ipsum() +
  theme(legend.position='none')
```